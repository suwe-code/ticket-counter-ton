"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const node_fs_1 = __importDefault(require("node:fs"));
const node_path_1 = __importDefault(require("node:path"));
const sandbox_1 = require("@ton/sandbox");
const txLogs = [];
const getLogs = [];
beforeAll(() => {
    const originalCreate = sandbox_1.Blockchain.create.bind(sandbox_1.Blockchain);
    sandbox_1.Blockchain.create = async (...args) => {
        const blockchain = await originalCreate(...args);
        blockchain.enableCoverage();
        const originalVerbosity = { ...blockchain.verbosity };
        originalVerbosity.print = false;
        originalVerbosity.vmLogs = 'vm_logs_verbose';
        Object.defineProperty(blockchain, 'verbosity', {
            get() {
                return originalVerbosity;
            },
            set(_) {
                // prevent changes
            },
        });
        blockchain.verbosity = originalVerbosity;
        // @ts-expect-error error
        const origRegisterTx = blockchain.registerTxsForCoverage.bind(blockchain);
        // @ts-expect-error error
        const origRegisterGet = blockchain.registerGetMethodForCoverage.bind(blockchain);
        // @ts-expect-error error
        blockchain.registerTxsForCoverage = (txs) => {
            txLogs.push(...txs.map((tx) => tx.vmLogs));
            return origRegisterTx(txs);
        };
        // @ts-expect-error error
        blockchain.registerGetMethodForCoverage = (gets) => {
            getLogs.push(gets.vmLogs);
            return origRegisterGet(gets);
        };
        return blockchain;
    };
});
afterAll(() => {
    const coveragePath = node_path_1.default.join(process.cwd(), 'coverage');
    const blueprintCoveragePath = node_path_1.default.join(coveragePath, 'blueprint');
    const testPath = expect.getState().testPath;
    const testRelative = node_path_1.default.relative(process.cwd(), testPath);
    const logsFilePath = node_path_1.default.join(blueprintCoveragePath, testRelative + '.json');
    node_fs_1.default.mkdirSync(node_path_1.default.dirname(logsFilePath), { recursive: true });
    node_fs_1.default.writeFileSync(logsFilePath, JSON.stringify({ txLogs, getLogs }, null, 2));
});
